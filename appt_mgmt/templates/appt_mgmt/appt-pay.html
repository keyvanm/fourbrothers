{% extends 'appt_mgmt/appt_mgmt_base.html' %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block title %}Confirm and pay{% endblock %}

{% block content %}
    <form method="post" action="">
        {% csrf_token %}
        <div class="page-header">
            <h1>Pay for your order</h1>
            <small>Do not press your browser's back button or you will risk losing your progress.</small>
        </div>

        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">
                    Your total is C$<span id="total-before-tax">{{ total_price_before_tax }}</span> + C${{ total_tax }}
                    (13% HST) + C$<span id="grat-amount">{{ total_gratuity }}</span> (<span
                        id="grat-perc">{{ appt.gratuity }}%</span> Gratuity) = C$<span
                        id="total">{{ total_price_after_gratuity }}</span>
                </h3>
            </div>
            <div class="panel-body">
                <ul class="list-unstyled">
                    {% for serviced_car in appt.servicedcar_set.all %}
                        <li>
                            {{ serviced_car.car }}
                            <ul>
                                {% for service in serviced_car.services.all %}
                                    <li>
                                        {{ service }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
                <div>
                    {% for k, v in pay_form.errs.items %}
                        <div class="alert alert-warning">{{ v }}</div>
                    {% endfor %}
                </div>
                <ul class="list-unstyled">
                    {% bootstrap_form pay_form %}
                    <a href="#" class="btn btn-default hidden" id="apply-promo">Apply promotion</a>
                    <script type="text/javascript">
                        $(function () {
                            var promoLastValue = '';
                            $("#id_promo_code").on('change keyup paste mouseup', function() {
                                if ($(this).val() != promoLastValue) {
                                    promoLastValue = $(this).val();
                                    if ($(this).val()){
                                        $("#apply-promo").removeClass("hidden");
                                    } else {
                                        $("#apply-promo").addClass("hidden");
                                    }
                                }
                            });
                            $("#apply-promo").click(function () {
                                window.location.assign(window.location.pathname + "?promo_code=" + $("#id_promo_code").val());
                            });
                            $("#id_loyalty").change(function () {
                                window.location.assign(window.location.pathname + "?loyalty=" + $("#id_loyalty :selected").val());
                            });
                        });
                    </script>
                </ul>
                <a href="{% url 'homepage' %}" class="btn btn-default">Cancel</a>
                {#                <input class="btn btn-primary" type="submit" value="Pay"/>#}
                <script
                        src="https://checkout.stripe.com/checkout.js" class="stripe-button"
                        data-key="{{ stripe_public_key }}"
                        {#                        data-amount="{{ total_price_cents }}"#}
                        data-name="FourBrothers"
                        {#                        data-description="${{ total_price_after_gratuity }}"#}
                        {#                        data-image="https://s3.amazonaws.com/stripe-uploads/acct_14sgA4LTjRqtW0Rpmerchant-icon-1414533378555-fb_logo.png"#}
                        data-zip-code="true"
                        data-currency="CAD"
                        data-email="{{ user.email }}">
                </script>
            </div>
            <div class="panel-footer">All prices are in Canadian Dollars (CAD)</div>
        </div>

    </form>
{% endblock %}